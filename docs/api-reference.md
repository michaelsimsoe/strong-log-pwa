# StrongLog V1.0 API Reference (Optional Sync Service)

**Version:** 0.1
**Date:** 2025-05-22
**Author:** 3 Arkitekten (AI)

This document describes the REST API provided by the (optional) StrongLog backend server for the purpose of data synchronization with the StrongLog PWA client. All communication will be over HTTPS.

## 1. General Principles

* **Style:** RESTful API over HTTPS.
* **Data Format:** JSON for all request and response bodies.
* **Authentication:** Endpoints will be protected and require Bearer Token authentication (e.g., JWT) obtained after user account creation and login (as per Epic 7.6). The token will be passed in the `Authorization` header.
* **Versioning:** API will be versioned, e.g., `/api/v1/...`.
* **Error Handling:** Standard HTTP status codes will be used:
  * `200 OK`: Request successful.
  * `201 Created`: Resource successfully created.
  * `204 No Content`: Request successful, no content to return (e.g., after a DELETE).
  * `400 Bad Request`: Invalid request payload or parameters (client error). Response body should contain error details.
  * `401 Unauthorized`: Authentication token is missing or invalid.
  * `403 Forbidden`: Authenticated user does not have permission for the action.
  * `404 Not Found`: Requested resource does not exist.
  * `409 Conflict`: Conflict with the current state of the resource (e.g., trying to create a resource that already exists, or optimistic locking failure if implemented beyond V1.0 "last write wins").
  * `500 Internal Server Error`: Server-side error.
* **Conflict Resolution (V1.0):** "Last write wins" based on client-provided timestamps (`clientUpdatedAt`) for individual records. The server may use its own timestamping upon receipt for auditing.
* **Timestamps:** All synced entities should include `clientCreatedAt` and `clientUpdatedAt` timestamps (Unix ms, generated by the client) and potentially server-side `serverCreatedAt` and `serverUpdatedAt` timestamps in responses.
* **Unique IDs:** Client will generate UUIDs for all new local records (`id`). When synced, the server may assign its own `serverId` or use the client's UUID as the primary key on the backend. For simplicity in V1.0, we can assume the client-generated UUID (`id`) will be the common identifier across client and server for synced records.
* **Soft Deletes:** A `isDeleted: true` flag will be used to synchronize deletions.

## 2. Sync Process Overview (Client Perspective)

The client-side sync service will periodically (when online and sync is enabled) or on-demand:

1. Fetch changes from the server since its `lastSuccessfulServerSyncTimestamp`.
2. Merge server changes into local Dexie.js (applying "last write wins" based on `clientUpdatedAt` or server's authoritative timestamp if preferred for incoming changes).
3. Push local changes (new, updated, deleted records since `lastSuccessfulClientPushTimestamp`) to the server in batches per entity type.
4. Update `lastSuccessfulServerSyncTimestamp` and `lastSuccessfulClientPushTimestamp` locally upon success.

## 3. Resources & Endpoints

The following resources correspond to the main data entities defined in `docs/data-models.md`. Payloads will generally mirror the TypeScript interfaces defined there, with added sync-specific fields (e.g., `clientUpdatedAt`, `isDeleted`). Zod schemas will be used on the client to validate request/response payloads.

---

### 3.1. User Settings (`/api/v1/user-settings`)

* **Description:** Manages synchronization of user-specific application settings. Expected to be a single record per user.
* **`GET /api/v1/user-settings`**
  * Description: Retrieves the user's settings from the server.
  * Response `200 OK`: `UserSettingsSyncPayload` (see `docs/data-models.md`, with sync fields).
* **`PUT /api/v1/user-settings`**
  * Description: Creates or updates the user's settings on the server. Client sends its current settings record.
  * Request Body: `UserSettingsSyncPayload`.
  * Response `200 OK` or `201 Created`: `UserSettingsSyncResponse` (confirming save, with server timestamps).

---

### 3.2. Exercise Definitions (`/api/v1/exercise-definitions`)

* **Description:** Manages synchronization of custom and potentially pre-populated exercise definitions.
* **`GET /api/v1/exercise-definitions?since={timestamp_ms}`**
  * Description: Retrieves all exercise definitions created or updated on the server since the given `timestamp_ms`.
  * Response `200 OK`: `{ "exerciseDefinitions": ExerciseDefinitionSyncPayload[], "newSyncTimestamp": number }`.
* **`POST /api/v1/exercise-definitions/batch`**
  * Description: Client sends a batch of new or updated exercise definitions.
  * Request Body: `{ "exerciseDefinitionsToSync": ExerciseDefinitionSyncPayload[] }`.
  * Response `200 OK`: `{ "results": [{ "localId": string, "serverId": string, "status": "created" | "updated" | "conflict" | "error", "errorDetails"?: string }], "batchTimestamp": number }`.

---

### 3.3. Workout Logs (`/api/v1/workout-logs`)

* **Description:** Manages synchronization of completed workout logs. Syncing a `WorkoutLog` implies also syncing its associated `LoggedSet` records.
* **`GET /api/v1/workout-logs?since={timestamp_ms}`**
  * Description: Retrieves workout logs (and their sets) created/updated on server since `timestamp_ms`.
  * Response `200 OK`: `{ "workoutLogs": WorkoutLogSyncPayloadIncludingSets[], "newSyncTimestamp": number }`.
    * `WorkoutLogSyncPayloadIncludingSets` would be `WorkoutLogSyncPayload` with an embedded array of `LoggedSetSyncPayload`.
* **`POST /api/v1/workout-logs/batch`**
  * Description: Client sends a batch of new or updated workout logs (including their sets).
  * Request Body: `{ "workoutLogsToSync": WorkoutLogSyncPayloadIncludingSets[] }`.
  * Response `200 OK`: Similar batch results structure as Exercise Definitions.

*(This pattern of GET /resource?since={ts} and POST /resource/batch will be repeated for most other top-level entities to facilitate efficient batch synchronization.)*

---

### 3.4. Logged Sets (`/api/v1/logged-sets`)

* **Note:** Logged sets are deeply tied to `WorkoutLogs`. It's generally recommended to sync them as part of the `WorkoutLog` payload (as described in 3.3) to maintain integrity. If independent syncing of sets is ever needed (less likely for V1.0), separate endpoints could be defined, but this adds complexity. For V1.0, assume sets are synced *with* their parent `WorkoutLog`.

---

### 3.5. Workout Templates (`/api/v1/workout-templates`)

* **Description:** Manages synchronization of user-created workout templates (including their `WorkoutTemplateExerciseInstances`).
* Endpoints:
  * **`GET /api/v1/workout-templates?since={timestamp_ms}`**
    * Response: `{ "workoutTemplates": WorkoutTemplateSyncPayloadIncludingInstances[], "newSyncTimestamp": number }`
  * **`POST /api/v1/workout-templates/batch`**
    * Request: `{ "workoutTemplatesToSync": WorkoutTemplateSyncPayloadIncludingInstances[] }`
    * Response: Batch results.

---

### 3.6. Program Definitions (`/api/v1/program-definitions`)

* **Description:** Manages synchronization of user-created program definitions.
* Endpoints:
  * **`GET /api/v1/program-definitions?since={timestamp_ms}`**
    * Response: `{ "programDefinitions": ProgramDefinitionSyncPayload[], "newSyncTimestamp": number }`
  * **`POST /api/v1/program-definitions/batch`**
    * Request: `{ "programDefinitionsToSync": ProgramDefinitionSyncPayload[] }`
    * Response: Batch results.

---

### 3.7. Active Program Instances (`/api/v1/active-program-instances`)

* **Description:** Manages synchronization of the state of programs actively being followed by the user.
* Endpoints:
  * **`GET /api/v1/active-program-instances?since={timestamp_ms}`**
    * Response: `{ "activeProgramInstances": ActiveProgramInstanceSyncPayload[], "newSyncTimestamp": number }`
  * **`POST /api/v1/active-program-instances/batch`**
    * Request: `{ "activeProgramInstancesToSync": ActiveProgramInstanceSyncPayload[] }`
    * Response: Batch results.

---

### 3.8. Progression Rules (`/api/v1/progression-rules`)

* **Description:** Manages synchronization of user-defined progression rules (FRX).
* Endpoints:
  * **`GET /api/v1/progression-rules?since={timestamp_ms}`**
    * Response: `{ "progressionRules": ProgressionRuleSyncPayload[], "newSyncTimestamp": number }`
  * **`POST /api/v1/progression-rules/batch`**
    * Request: `{ "progressionRulesToSync": ProgressionRuleSyncPayload[] }`
    * Response: Batch results.

---

### 3.9. User Goals (`/api/v1/user-goals`)

* **Description:** Manages synchronization of user-defined goals (FRZ).
* Endpoints:
  * **`GET /api/v1/user-goals?since={timestamp_ms}`**
    * Response: `{ "userGoals": UserGoalSyncPayload[], "newSyncTimestamp": number }`
  * **`POST /api/v1/user-goals/batch`**
    * Request: `{ "userGoalsToSync": UserGoalSyncPayload[] }`
    * Response: Batch results.

---

### 3.10. User Bodyweight Log (`/api/v1/user-bodyweight-log`)

* **Description:** Manages synchronization of user's bodyweight entries.
* Endpoints:
  * **`GET /api/v1/user-bodyweight-log?since={timestamp_ms}`**
    * Response: `{ "userBodyweightLogEntries": UserBodyweightEntrySyncPayload[], "newSyncTimestamp": number }`
  * **`POST /api/v1/user-bodyweight-log/batch`**
    * Request: `{ "userBodyweightLogEntriesToSync": UserBodyweightEntrySyncPayload[] }`
    * Response: Batch results.

---

### 3.11. Applied Progression Log (Optional Sync) (`/api/v1/applied-progression-log`)

* **Description:** Manages synchronization of the log of applied progressions (if this history itself needs to be synced).
* Endpoints: (Similar GET /since and POST /batch structure if synced)
  * *To be confirmed if this specific log needs to be synced or if it's derived/local only.*

---

## 4. Sync Payload Structure Details

For each `...SyncPayload` mentioned above, it will extend the base TypeScript interface defined in `docs/data-models.md` and add fields necessary for synchronization, for example:

```typescript
// Example: Base for syncable entities
export interface SyncableEntity {
  id: string; // Client-generated UUID, primary key locally
  clientCreatedAt: number;
  clientUpdatedAt: number;
  isDeleted?: boolean; // For soft deletes
  // Server may add serverId, serverCreatedAt, serverUpdatedAt in responses
}

// Example: WorkoutLogSyncPayload
export interface WorkoutLogSyncPayload extends WorkoutLog, SyncableEntity {
  // WorkoutLog fields...
  // SyncableEntity fields...
  loggedSets: LoggedSetSyncPayload[]; // Nested for transactional consistency
}

export interface LoggedSetSyncPayload extends LoggedSet, SyncableEntity {
  // LoggedSet fields...
  // SyncableEntity fields...
}
```

Zod schemas will be defined on the client to validate these payloads.

## 5. External APIs Consumed

This section of the template is not applicable here, as this document defines the API *provided by* the StrongLog backend for client consumption.

## 6. AWS Service SDK Usage (or other Cloud Providers)

This section is not applicable for this API reference document, as it pertains to backend implementation details which are deferred.

## Change Log

| Change        | Date         | Version | Description                                                                         | Author            |
|---------------|--------------|---------|-------------------------------------------------------------------------------------|-------------------|
| Initial draft | 2025-05-22   | 0.1     | Initial draft defining REST API endpoints and principles for optional data sync. | 3 Arkitekten (AI) |
