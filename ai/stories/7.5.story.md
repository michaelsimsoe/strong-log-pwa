# Story 7.5: Comprehensive V1.0 Data Export - Data Aggregation & File Generation (in Web Worker)

**Status:** Draft

## Goal & Context

**User Story:** As a system, when a user requests a data export, I need to aggregate all their V1.0 data (workouts, custom exercises, Progression Rules, Program Definitions, Active Program states, Goals, User settings) from IndexedDB (in a Web Worker) and generate downloadable files in the selected format (CSV/JSON) without freezing the UI.

**Context:** This story implements the core logic for data export. It involves fetching all user data from Dexie.js, formatting it into CSV or JSON, and making it available for download. This process will run in a Web Worker to handle potentially large datasets efficiently.

## Detailed Requirements

* **Data Aggregation:** Retrieve all relevant data from IndexedDB: `WorkoutLog`s (with their `LoggedSet`s), custom `ExerciseDefinition`s, `ProgressionRule`s, `ProgramDefinition`s, `ActiveProgramInstance`s, `UserGoal`s, `UserBodyweightLog`s, and `UserSettings`.
* **CSV Export:** Generate a set of related CSV files (e.g., `workouts.csv`, `sets.csv`, `exercises.csv`, `rules.csv`, etc.) to represent the different data entities and their relationships.
* **JSON Export:** Generate a single, well-structured JSON file containing all V1.0 data, preserving relationships between entities (e.g., workout logs with nested sets).
* The export process should run client-side. The data aggregation (fetching from Dexie.js) and file formatting (to JSON/CSV) process should occur within a **Web Worker** to prevent UI freezes. **Comlink** will be used for managing communication with this worker.

## Acceptance Criteria (ACs)

* AC1: For CSV export, multiple well-structured CSV files representing all specified V1.0 data types are generated by the export worker and can be downloaded by the user.
* AC2: For JSON export, a single, well-structured JSON file representing all specified V1.0 data types and their relationships is generated by the export worker and can be downloaded by the user.
* AC3: Exported data accurately and completely reflects the user's data currently stored in IndexedDB for all V1.0 entities.
* AC4: The export process handles potentially large datasets without crashing the browser or freezing the UI, due to worker offloading.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

* **Relevant Files:**
  * Files to Create/Modify:
    * `src/services/export/export.worker.ts` (New Web Worker for data export).
    * `src/services/export/exportService.ts` (Main thread service to interact with the worker via Comlink).
    * `src/features/data-management/pages/ExportDataPage.tsx` (Integrate with `exportService.ts`).
  * Files to Reference:
    * `src/services/data/db.ts` (Dexie.js instance, to be accessed by worker).
    * `src/types/data.types.ts` (All V1.0 data models).
    * `vite.config.ts` (for worker bundling).
    * `src/services/engines/comlink.setup.ts` (extend for export worker).
  * _(Hint: See `docs/project-structure.md`. `docs/architecture.md` mentions Web Workers and Comlink.)_

* **Key Technologies:**
  * Shared Web Workers, Comlink.
  * Dexie.js (accessed within the worker).
  * TypeScript.
  * CSV generation library (client-side, e.g., PapaParse for unparsing if suitable, or custom logic - Note: PapaParse not in current tech stack). JSON.stringify for JSON.
  * FileSaver.js (or similar, or native browser capabilities) for initiating download of generated Blob/string.
  * _(Hint: See `docs/tech-stack.md` for full list)_

* **API Interactions / SDK Usage:**
  * Comlink API for main thread to worker communication (e.g., `exportData(format: 'csv' | 'json')`).
  * Dexie.js API (`db.table.toArray()`) within the worker to fetch all data from each table.
  * Browser API for creating downloadable files (e.g., `Blob`, `URL.createObjectURL`, `<a>` download attribute).

* **Data Structures:**
  * Arrays of all V1.0 data entities fetched from Dexie.js.
  * Defined structure for the output JSON (e.g., a root object with keys for each data type).
  * Defined set of CSV files and their respective headers/columns.

* **Environment Variables:**
  * N/A for this story.

* **Coding Standards Notes:**
  * Ensure worker logic is robust and handles potential errors during data fetching or formatting.
  * For CSV, consider how to represent relationships (e.g., `workout_id` in `sets.csv`).
  * JSON export should ideally be a single, self-contained file that could potentially be re-imported (though import of this full JSON is not a V1.0 requirement).
  * _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

* [ ] **(Engine Infrastructure TS-11, TS-12):** Set up a new Shared Web Worker (`export.worker.ts`). Configure Vite for its bundling. Ensure Comlink is set up for communication and Dexie.js (`db`) is accessible within this worker.
* [ ] Define the detailed schema/structure for the JSON export (single file containing all data types).
* [ ] Define the set of CSV files to be generated and the columns for each (e.g., `user_settings.csv`, `exercise_definitions.csv`, `workout_logs.csv`, `logged_sets.csv`, `progression_rules.csv`, `program_definitions.csv`, `active_program_instances.csv`, `user_goals.csv`, `user_bodyweight_log.csv`).
* [ ] Implement logic within `export.worker.ts`:
  * A function to fetch all records from each relevant Dexie.js table (`UserSettings`, `ExerciseDefinition`, `WorkoutLog`, `LoggedSet`, `ProgressionRule`, `ProgramDefinition`, `ActiveProgramInstance`, `UserGoal`, `UserBodyweightLog`).
  * A function to format the fetched data into the defined JSON structure.
  * Functions to format the fetched data into the defined set of CSV strings (using a CSV library or custom logic).
  * Expose a method via Comlink like `generateExportData(format: 'csv' | 'json')` that returns the file content(s) (e.g., JSON string, or an object mapping CSV filenames to CSV strings).
* [ ] Implement `exportService.ts` on the main thread to:
  * Call the worker's `generateExportData` method via Comlink.
  * Receive the file content(s).
  * Initiate browser download(s) of the generated file(s) (e.g., creating a Blob, using `URL.createObjectURL`, and an `<a>` tag, or FileSaver.js).
* [ ] Connect the UI from Story 7.4 to this `exportService.ts`.
* [ ] Provide UI feedback during export (e.g., "Exporting data...") and on completion/error.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (Vitest):**
  * Test data fetching logic within the worker (mock Dexie.js).
  * Test JSON formatting logic with sample data.
  * Test CSV formatting logic for each planned CSV file with sample data.
  * Test `exportService.ts` for worker interaction and download initiation (mock worker responses and browser download).
* **Integration Tests (Vitest, worker context):**
  * Test the export worker with a seeded Dexie.js instance. Call `generateExportData` and verify the structure and content of the returned JSON string or CSV strings.
* **E2E Tests (Playwright):**
  * Populate the app with diverse data across all V1.0 entities (workouts, rules, programs, goals etc.).
  * Initiate a JSON export. Verify a single JSON file is downloaded. Inspect its content for accuracy and completeness.
  * Initiate a CSV export. Verify multiple CSV files are downloaded. Inspect their content for accuracy and completeness.
  * Test with a larger dataset (if feasible to generate for E2E) to confirm UI doesn't freeze.
* _(Hint: See `docs/testing-strategy.md` for the overall approach)_

## Story Wrap Up (Agent Populates After Execution)

* **Agent Model Used:** `<Agent Model Name/Version>`
* **Completion Notes:**
* **Change Log:**
  * Initial Draft
