# Story 4.6: Executing & Logging Program Workouts (Including Partial Completion with FRY Logic)

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want to select and perform a workout that is part of my active program, log my performance (including handling partial completions managed by FRY), and have this data update my program's state and feed the progression engine.

**Context:** This story connects the FRY engine's planning capabilities to the actual workout logging experience. It ensures that users log against FRY-generated plans (which include FRX adjustments and carry-overs) and that program state is correctly updated post-logging, including handling of partially completed workouts and carry-over logic within the FRY worker.

## Detailed Requirements

* User can select a suggested program workout (from dashboard or program view, generated by FRY via Story 4.4) to start logging.
* The logging interface will be pre-filled with the exercises and target parameters as determined by FRY (including FRX adjustments and carry-overs from previous partial completions).
* User logs their actual performance as usual (using logging UI from Epic 1 & 2).
* If a user only completes some exercises/sets of a prescribed program workout:
  * Only the completed parts are logged as performed.
  * The Progression Engine (FRX) should only consider the completed exercises/sets when evaluating rules for that session. (This is an FRX behavior, FRY provides context).
  * When a program workout is partially completed, any uncompleted exercises designated for **'carry over by default'** must be identified and stored (e.g., in the `ActiveProgramInstance.carriedOverExercises` field in Dexie.js) by the FRY engine or application logic interacting with FRY.
  * When the FRY engine generates the _next_ workout plan for that program, it must incorporate these `carriedOverExercises` into that plan, in addition to the regularly scheduled exercises for that session.
* Upon completion, the workout log is saved to Dexie.js, and the active program's state is updated by FRY (or application logic calling FRY worker's `logProgramWorkoutCompletion` method) (e.g., advances to the next workout in sequence, logs completion date, updates carry-overs).

## Acceptance Criteria (ACs)

* AC1: User can start a workout session that is part of an active program, using a plan generated by the FRY worker (Story 4.4 output).
* AC2: The workout session logging UI is pre-filled with exercises and auto-adjusted targets from the FRY-generated plan, including any carry-over exercises from the previous session.
* AC3: User can log their actual performance for each set of the program workout.
* AC4: If user performs only a subset of the planned workout and saves, this is correctly logged. The FRY worker logic (or app logic calling it) correctly identifies uncompleted exercises for potential carry-over based on the initial plan.
* AC5: Upon completing and saving the workout, the `ActiveProgramInstance`'s state (e.g., `lastCompletedWorkoutDate`, `currentWorkoutOrderInProgram`, and `carriedOverExercises` for the _next_ session) is correctly updated in Dexie.js via the FRY worker's `logProgramWorkoutCompletion` method.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

* **Relevant Files:**
  * Files to Modify:
    * `src/features/logging/pages/ActiveWorkoutPage.tsx` (to accept and pre-fill with `GeneratedWorkoutPlan` from FRY).
    * `src/services/engines/fry.worker.ts` (Implement `logProgramWorkoutCompletion` method).
    * `src/services/engines/fry/fryLogic.ts` (Implement `handleCarryOverExercises` and extend `updateProgramStateOnCompletion`).
    * `src/services/data/workoutService.ts` (ensure workout saving triggers program update if it's a program workout).
    * `src/features/dashboard/components/TodayFocus.tsx` (or similar UI that provides the "Start Program Workout" button).
  * Files to Create/Reference:
    * `src/types/data.types.ts` (`GeneratedWorkoutPlan`, `ActiveProgramInstance.carriedOverExercises` structure).
  * _(Hint: `docs/FRY Implementation Plan.md` details `logProgramWorkoutCompletion` and `handleCarryOverExercises`. `docs/fit_together.md` describes data flow.)_

* **Key Technologies:**
  * React, `shadcn/ui`, Dexie.js, Zod, TypeScript, Shared Web Workers, Comlink.
  * _(Hint: See `docs/tech-stack.md` for full list)_

* **API Interactions / SDK Usage:**
  * Main thread calls FRY worker's `logProgramWorkoutCompletion` method via Comlink, passing `activeProgramInstanceId` and `workoutLogId` (and potentially details of planned vs actual to help worker identify carry-overs).
  * FRY worker uses Dexie.js to read `ActiveProgramInstance`, `WorkoutLog`, and update `ActiveProgramInstance`.

* **Data Structures:**
  * `GeneratedWorkoutPlan` (input to logging UI).
  * `WorkoutLog` and `LoggedSet`s (output of logging UI).
  * `ActiveProgramInstance.carriedOverExercises`: `WorkoutTemplateExerciseInstance[]` (or similar structure to define exercises and their original targets).
  * `ActiveProgramInstance` state fields (`lastCompletedWorkoutDate`, `currentWorkoutOrderInProgram`).

* **Environment Variables:**
  * N/A for this story.

* **Coding Standards Notes:**
  * The logic to determine what was "planned" for a workout (to identify uncompleted/carry-over items) needs to be robust. The `GeneratedWorkoutPlan` provided by FRY for the session is the source of truth for what was planned.
  * Ensure updates to `ActiveProgramInstance` are atomic if multiple fields are changed.
  * _(Hint: See `docs/coding-standards.md` and `docs/FRY Implementation Plan.md`)_

## Tasks / Subtasks

* [ ] Modify the workout logging initiation flow so that if a program workout is selected, the `ActiveWorkoutPage.tsx` is initialized with the `GeneratedWorkoutPlan` (from Story 4.4 via FRY worker).
* [ ] Update `ActiveWorkoutPage.tsx` to correctly display and handle exercises/targets from the pre-filled plan, including any `carriedOverExercises`.
* [ ] Implement `handleCarryOverExercises` function in `src/services/engines/fry/fryLogic.ts`. This function will:
  * Compare the saved `WorkoutLog`'s content against the `GeneratedWorkoutPlan` that was used for that session (this plan might need to be passed to `logProgramWorkoutCompletion` or fetched based on context).
  * Identify uncompleted exercises and store them in the `ActiveProgramInstance.carriedOverExercises` field for the _next_ session.
* [ ] Extend `updateProgramStateOnCompletion` in `fryLogic.ts` to correctly advance `currentWorkoutOrderInProgram`, update `lastCompletedWorkoutDate`, and manage the workout history within `ActiveProgramInstance`.
* [ ] Implement the `logProgramWorkoutCompletion` method in `fry.worker.ts` which orchestrates calling `handleCarryOverExercises` and `updateProgramStateOnCompletion`, then saves the updated `ActiveProgramInstance` to Dexie.js.
* [ ] Ensure the application logic on the main thread calls this FRY worker method after a program workout is successfully saved to Dexie.js.
* [ ] Modify `generateNextWorkoutContent` (from Story 4.4, in `fryLogic.ts`) to check for and include any `carriedOverExercises` from `ActiveProgramInstance` into the next `GeneratedWorkoutPlan`.
* [ ] Design UI representation for how carried-over exercises are presented to the user in their next workout plan (e.g., marked specially).

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Refer to `docs/FRY testplan.md`.

* **Unit Tests (Vitest):**
  * Test `handleCarryOverExercises` logic with various scenarios of partial completion.
  * Test `generateNextWorkoutContent` to ensure it correctly includes `carriedOverExercises`.
* **Integration Tests (Vitest, worker context):**
  * Test the FRY worker's `logProgramWorkoutCompletion` Comlink method: Provide IDs, ensure worker updates `ActiveProgramInstance` state and `carriedOverExercises` in Dexie.js correctly based on a (mocked) `WorkoutLog` and (mocked) initial plan.
* **E2E Tests (Playwright):**
  * Full flow: Start a FRY-generated program workout -> Log only some exercises -> Finish.
  * Start the _next_ program workout -> Verify uncompleted exercises from previous session are carried over and present in the plan.
  * Verify `ActiveProgramInstance` state (e.g. current day) updates correctly.
* _(Hint: See `docs/testing-strategy.md` and `docs/FRY testplan.md` for details)_

## Story Wrap Up (Agent Populates After Execution)

* **Agent Model Used:** `<Agent Model Name/Version>`
* **Completion Notes:**
* **Change Log:**
  * Initial Draft
